using DevExpress.Utils;
using DevExpress.Xpf.DemoBase.DemoTesting;
using DevExpress.Xpf.Printing;
using System;

namespace ReportWpfDemo.Tests {
    static class DocumentPagesReadyConditionFactory {
        // InstantVB 2.7 can't automatically resolve return value type of anonymous delegate or lambda.
        // We use ConditionAdapter so that autogenerated VB code doesn't have warnings 'convert Object to boolean'
        class ConditionAdapter {
            const int sufficientPageCount = 10;
            readonly BaseDemoTestingFixture fixture;

            public ConditionAdapter(BaseDemoTestingFixture fixture) {
                Guard.ArgumentNotNull(fixture, "fixture");
                this.fixture = fixture;
            }

            public bool EvaluateCondition() {
                if(fixture.DemoBaseTesting.CurrentDemoModule == null)
                    return false;
                var preview = BaseTestingFixture.HelperActions.FindElementByType<DocumentPreviewControl>(fixture.DemoBaseTesting.CurrentDemoModule);
                return preview != null && (preview.PageCount > sufficientPageCount || (preview.PageCount > 0 && preview.Document.IsCreating == false));
            }
        }

        /// <summary>
        /// Creates new instance of Condition that resolves to 'true' when document build is complete or sufficient page count was achieved.
        /// </summary>
        /// <param name="fixture"></param>
        /// <returns></returns>
        public static Func<bool> Create(BaseDemoTestingFixture fixture) {
            ConditionAdapter conditionAdapter = new ConditionAdapter(fixture);
            return () => conditionAdapter.EvaluateCondition();
        }
    }
}
